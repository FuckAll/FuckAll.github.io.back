<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  Kubernetes应用的滚动升级 - 重剑无锋，大巧不工。
  
  </title>
 <meta name="description" content="">
 <link href="atom.xml" rel="alternate" title="重剑无锋，大巧不工。" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">重剑无锋，大巧不工。</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; 重剑无锋，大巧不工。</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>Golang</label></li>

          
            <li><a title="Golang Sort排序" href="14730511199413.html">Golang Sort排序</a></li>
          
            <li><a title="Golang Label妙用" href="14729947807865.html">Golang Label妙用</a></li>
          
            <li><a title="Golang 并发问题" href="14727913418128.html">Golang 并发问题</a></li>
          
            <li><a title="Golang 反射问题" href="14727911561394.html">Golang 反射问题</a></li>
          
            <li><a title="Golang 指针问题" href="14727906220786.html">Golang 指针问题</a></li>
          
            <li><a title="Golang 基础类型" href="14726074871676.html">Golang 基础类型</a></li>
          

      
        <li class="divider"></li>
        <li><label>容器相关</label></li>

          
            <li><a title="容器脚本" href="14726120122280.html">容器脚本</a></li>
          
            <li><a title="Kubernetes应用的滚动升级" href="14719470938560.html">Kubernetes应用的滚动升级</a></li>
          
            <li><a title="Docker Registry" href="14719166233226.html">Docker Registry</a></li>
          

      
        <li class="divider"></li>
        <li><label>Nginx</label></li>

          
            <li><a title="Nginx HTTP2.0" href="14719476150773.html">Nginx HTTP2.0</a></li>
          
            <li><a title="Web 基础" href="14719470176268.html">Web 基础</a></li>
          
            <li><a title="Let's Encrypt 获取Nginx证书" href="14719253380529.html">Let's Encrypt 获取Nginx证书</a></li>
          

      
        <li class="divider"></li>
        <li><label>数据库</label></li>

          
            <li><a title="PostgreSql语句集锦" href="14724588246571.html">PostgreSql语句集锦</a></li>
          
            <li><a title="Postgresql 备份与恢复" href="14724369503027.html">Postgresql 备份与恢复</a></li>
          
            <li><a title="PostgreSql主从配置" href="14719510431478.html">PostgreSql主从配置</a></li>
          

      
        <li class="divider"></li>
        <li><label>股票基础</label></li>

          
            <li><a title="选股模型" href="14723863067284.html">选股模型</a></li>
          
            <li><a title="股票线图" href="14723721762973.html">股票线图</a></li>
          
            <li><a title="股票量价比" href="14723615341044.html">股票量价比</a></li>
          

      
        <li class="divider"></li>
        <li><label>个人收集</label></li>

          
            <li><a title="技术类博客收集" href="14727777201831.html">技术类博客收集</a></li>
          

      
        <li class="divider"></li>
        <li><label>算法</label></li>

          
            <li><a title="字符串匹配算法" href="14728851727641.html">字符串匹配算法</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>Golang</span></li>
                        
                          <li><a title="Golang Sort排序" href="14730511199413.html">Golang Sort排序</a></li>
                        
                          <li><a title="Golang Label妙用" href="14729947807865.html">Golang Label妙用</a></li>
                        
                          <li><a title="Golang 并发问题" href="14727913418128.html">Golang 并发问题</a></li>
                        
                          <li><a title="Golang 反射问题" href="14727911561394.html">Golang 反射问题</a></li>
                        
                          <li><a title="Golang 指针问题" href="14727906220786.html">Golang 指针问题</a></li>
                        
                          <li><a title="Golang 基础类型" href="14726074871676.html">Golang 基础类型</a></li>
                        

                    
                      <li class="side-title"><span>容器相关</span></li>
                        
                          <li><a title="容器脚本" href="14726120122280.html">容器脚本</a></li>
                        
                          <li><a title="Kubernetes应用的滚动升级" href="14719470938560.html">Kubernetes应用的滚动升级</a></li>
                        
                          <li><a title="Docker Registry" href="14719166233226.html">Docker Registry</a></li>
                        

                    
                      <li class="side-title"><span>Nginx</span></li>
                        
                          <li><a title="Nginx HTTP2.0" href="14719476150773.html">Nginx HTTP2.0</a></li>
                        
                          <li><a title="Web 基础" href="14719470176268.html">Web 基础</a></li>
                        
                          <li><a title="Let's Encrypt 获取Nginx证书" href="14719253380529.html">Let's Encrypt 获取Nginx证书</a></li>
                        

                    
                      <li class="side-title"><span>数据库</span></li>
                        
                          <li><a title="PostgreSql语句集锦" href="14724588246571.html">PostgreSql语句集锦</a></li>
                        
                          <li><a title="Postgresql 备份与恢复" href="14724369503027.html">Postgresql 备份与恢复</a></li>
                        
                          <li><a title="PostgreSql主从配置" href="14719510431478.html">PostgreSql主从配置</a></li>
                        

                    
                      <li class="side-title"><span>股票基础</span></li>
                        
                          <li><a title="选股模型" href="14723863067284.html">选股模型</a></li>
                        
                          <li><a title="股票线图" href="14723721762973.html">股票线图</a></li>
                        
                          <li><a title="股票量价比" href="14723615341044.html">股票量价比</a></li>
                        

                    
                      <li class="side-title"><span>个人收集</span></li>
                        
                          <li><a title="技术类博客收集" href="14727777201831.html">技术类博客收集</a></li>
                        

                    
                      <li class="side-title"><span>算法</span></li>
                        
                          <li><a title="字符串匹配算法" href="14728851727641.html">字符串匹配算法</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 <div class="markdown-body">
<h1>Kubernetes应用的滚动升级</h1>

<h2 id="toc_0">传统的高可用步骤：</h2>

<ol>
<li>将版本的业务进行启动</li>
<li>切换nginx等的配置，切换生产环境</li>
<li>检查上线代码是否有问题</li>
<li>如果没有问题就继续，如果有问题快速的切换配置，将版本快速的回退到上一个版本。
这样做的优缺点：

<ul>
<li>先说优点

<ul>
<li>回滚速度快，能够在第一时间发现错误.</li>
</ul></li>
<li>再说缺点：

<ul>
<li>过多的人工操作，导致人为失误很大程度上影响发布质量。</li>
</ul></li>
</ul></li>
</ol>

<h2 id="toc_1">Kubernetes 方式滚动升级：</h2>

<ol>
<li>升级过程：

<ul>
<li>和传统的滚动升级的思路是一样的，即将新的pod升级上去，然后慢慢的将旧的pod数量降到0，从而实现升级。</li>
</ul></li>
<li><p>下面演示升级过程：</p>

<ol>
<li><p>本地微服务：</p>

<pre><code>$kubectl get rc 
NAME           DESIRED   CURRENT   AGE
account        2         2         1h
activity       2         2         1h

</code></pre></li>
<li><p>服务升级：</p>

<pre><code> $[root@ali-k8s-03 rc]# kubectl rolling-update account --image=reg.17mei.top/account/8092af07-account:v1.2.1
 Created account-e041dc4989c5cd11b305bab7075dd2e7
 Scaling up account-e041dc4989c5cd11b305bab7075dd2e7 from 0 to 2, scaling down account from 2 to 0 (keep 2 pods available, don&#39;t exceed 3 pods)
 Scaling account-e041dc4989c5cd11b305bab7075dd2e7 up to 1
 Scaling account down to 1
 Scaling account-e041dc4989c5cd11b305bab7075dd2e7 up to 2
 Scaling account down to 0
 Update succeeded. Deleting old controller: account
 Renaming account-e041dc4989c5cd11b305bab7075dd2e7 to account
 replicationcontroller &quot;account&quot; rolling updated
</code></pre>

<ul>
<li>过程解释：首先，k8s创建一个新的RC，名字叫account-e041dc4989c5cd11b305bab7075dd2e7，总数为2个pod，这个过程是保证有两个pods是可用的。最终滚动升级完成。</li>
</ul></li>
<li><p>服务回滚：<br/>
如果发布的过程中发现有问题，那么就需要回滚操作，下面是回滚操作的步骤：</p>

<pre><code>account                                     2         2         47m
activity                                    2         2         2h
activity-db96883e53ab1ed3f11a99ddfbdf31f7   1         1         28m
#此时用activity进行回滚演示，因为已经发布完成的就不能直接回滚，已经发布的回滚相当于一次从新的发布，此时如果想要回滚操作的话就是直接进行下面的操作
$ kubectl rolling-update activity --rollback
</code></pre></li>
</ol></li>
</ol>

<h2 id="toc_2">我是如何进行Kubernetes进行应用的升级的：</h2>

<ol>
<li><p>以上两种方式遇到的问题：</p>

<ul>
<li><p>先说kubernets.</p>

<ol>
<li>Kubernetes滚动升级的方式对于我这种使用配置比较低的机器，速度较慢，时间成本高.</li>
<li>回滚的速度更加的慢，有种想死的冲动。</li>
<li>发到线上测试人员发现问题要立马回滚，搞得大家都很紧张。</li>
</ol></li>
<li><p>再说传统的方式</p>

<ol>
<li>部署速度慢，大公司有专门的代码发布平台，小公司可能就手动发布了。</li>
<li>人工出错情况多，由于一次上线需要很多的步骤所以人为出错的可能性就很高。</li>
<li>因为代码的运行环境问题引发的问题是很难排除的，也许就是一个软件的版本问题。</li>
</ol></li>
<li><p>那么我是如何使用的。</p>

<ol>
<li>双份生产环境（业务量不大，不需要更多的生产环境），production01 和 production02，可以同时使用，也可以有一个备用，看业务量和对业务高可用的要求衡量。</li>
<li>每个微服务有一个yaml配置文件，用来快速升级部署。</li>
<li>升级过程：
  1) 首先将nginx对应组的业务下线，nginx已经做的很好了，能够平滑的下线。
  2) 升级刚才下线的一组服务，过程是删除一组服务，然后重新用新的配置文件上线一组服务。
  3) 刚上线的一组服务可以进行测试。无论测试多久都不会影响。
  4) 测试没有问题之后，可以切换nginx配置将应用上线。</li>
<li>升级过程出现问题回滚：

<ol>
<li>如果发布的过程中发现有问题，那么直接停止升级或者升级完成，因为是在一组下线的生产环境中，都不会发生问题。</li>
</ol></li>
<li>升级成功之后，将另外一组没有升级的线上节点不做任何的处理，防止有Bug要回滚到上一个版本。</li>
</ol></li>
</ul></li>
</ol>

<h2 id="toc_3">总结：</h2>

<pre><code>两个线上环境，快速升级和回滚都有好处。综合了一下传统的升级方式和Kubernetes的升级方式。早安，上海。
</code></pre>


</div>

<br /><br />
<hr />

<div class="row clearfix">
  <div class="large-6 columns">
	<div class="text-left" style="padding:15px 0px;">
		
	        <a href="14719476150773.html"  title="Previous Post: Nginx HTTP2.0">&laquo; Nginx HTTP2.0</a>
	    
	</div>
  </div>
  <div class="large-6 columns">
	<div class="text-right" style="padding:15px 0px;">
		
	        <a href="14719470176268.html" 
	        title="Next Post: Web 基础">Web 基础 &raquo;</a>
	    
	</div>
  </div>
</div>

<div class="row">
<div style="padding:0px 0.93em;" class="share-comments">
<!-- 多说评论框 start -->
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"fuckall"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
</div>
</div>
<script type="text/javascript">
	$(function(){
		var currentURL = '14719470938560.html';
		$('#side-nav a').each(function(){
			if($(this).attr('href') == currentURL){
				$(this).parent().addClass('active');
			}
		});
	});
</script>  
</div></div>


<div class="page-bottom">
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    <script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  </body>
</html>
