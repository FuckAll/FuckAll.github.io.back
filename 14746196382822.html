<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  Golang Context - 重剑无锋，大巧不工。
  
  </title>
 <meta name="description" content="">
 <link href="atom.xml" rel="alternate" title="重剑无锋，大巧不工。" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">重剑无锋，大巧不工。</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; 重剑无锋，大巧不工。</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>读书</label></li>

          
            <li><a title="如何阅读一本实用型的书--《如何阅读一本书》" href="14798734458692.html">如何阅读一本实用型的书--《如何阅读一本书》</a></li>
          

      
        <li class="divider"></li>
        <li><label>Golang</label></li>

          
            <li><a title="Golang Context" href="14746196382822.html">Golang Context</a></li>
          
            <li><a title="Golang 控制routine" href="14745112452162.html">Golang 控制routine</a></li>
          
            <li><a title="Golang 小技巧" href="14741728889918.html">Golang 小技巧</a></li>
          
            <li><a title="Golang Sort排序" href="14730511199413.html">Golang Sort排序</a></li>
          
            <li><a title="Golang Label妙用" href="14729947807865.html">Golang Label妙用</a></li>
          
            <li><a title="Golang 并发问题" href="14727913418128.html">Golang 并发问题</a></li>
          
            <li><a title="Golang 反射问题" href="14727911561394.html">Golang 反射问题</a></li>
          
            <li><a title="Golang 指针问题" href="14727906220786.html">Golang 指针问题</a></li>
          
            <li><a title="Golang 基础类型" href="14726074871676.html">Golang 基础类型</a></li>
          

      
        <li class="divider"></li>
        <li><label>容器相关</label></li>

          
            <li><a title="Docker可持续化部署如何做" href="14761747399282.html">Docker可持续化部署如何做</a></li>
          
            <li><a title="Kubernetes 监控" href="14750346668025.html">Kubernetes 监控</a></li>
          
            <li><a title="容器脚本" href="14726120122280.html">容器脚本</a></li>
          
            <li><a title="Kubernetes应用的滚动升级" href="14719470938560.html">Kubernetes应用的滚动升级</a></li>
          
            <li><a title="Docker Registry" href="14719166233226.html">Docker Registry</a></li>
          

      
        <li class="divider"></li>
        <li><label>Nginx</label></li>

          
            <li><a title="Nginx HTTP2.0" href="14719476150773.html">Nginx HTTP2.0</a></li>
          
            <li><a title="Web 基础" href="14719470176268.html">Web 基础</a></li>
          
            <li><a title="Let's Encrypt 获取Nginx证书" href="14719253380529.html">Let's Encrypt 获取Nginx证书</a></li>
          

      
        <li class="divider"></li>
        <li><label>数据库</label></li>

          
            <li><a title="Golang Postgresql" href="14742795357312.html">Golang Postgresql</a></li>
          
            <li><a title="PostgreSql语句集锦" href="14724588246571.html">PostgreSql语句集锦</a></li>
          
            <li><a title="Postgresql 备份与恢复" href="14724369503027.html">Postgresql 备份与恢复</a></li>
          
            <li><a title="PostgreSql主从配置" href="14719510431478.html">PostgreSql主从配置</a></li>
          

      
        <li class="divider"></li>
        <li><label>股票基础</label></li>

          
            <li><a title="个人选股" href="14764202917938.html">个人选股</a></li>
          
            <li><a title="选股模型" href="14723863067284.html">选股模型</a></li>
          
            <li><a title="股票线图" href="14723721762973.html">股票线图</a></li>
          
            <li><a title="股票量价比" href="14723615341044.html">股票量价比</a></li>
          

      
        <li class="divider"></li>
        <li><label>个人收集</label></li>

          
            <li><a title="git 常用方法" href="14745419664301.html">git 常用方法</a></li>
          
            <li><a title="读书" href="14734878748126.html">读书</a></li>
          
            <li><a title="技术类博客收集" href="14727777201831.html">技术类博客收集</a></li>
          

      
        <li class="divider"></li>
        <li><label>算法</label></li>

          
            <li><a title="字符串匹配算法" href="14728851727641.html">字符串匹配算法</a></li>
          

      
        <li class="divider"></li>
        <li><label>测试</label></li>

          
            <li><a title="Curl Http 测试" href="14742597754498.html">Curl Http 测试</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>读书</span></li>
                        
                          <li><a title="如何阅读一本实用型的书--《如何阅读一本书》" href="14798734458692.html">如何阅读一本实用型的书--《如何阅读一本书》</a></li>
                        

                    
                      <li class="side-title"><span>Golang</span></li>
                        
                          <li><a title="Golang Context" href="14746196382822.html">Golang Context</a></li>
                        
                          <li><a title="Golang 控制routine" href="14745112452162.html">Golang 控制routine</a></li>
                        
                          <li><a title="Golang 小技巧" href="14741728889918.html">Golang 小技巧</a></li>
                        
                          <li><a title="Golang Sort排序" href="14730511199413.html">Golang Sort排序</a></li>
                        
                          <li><a title="Golang Label妙用" href="14729947807865.html">Golang Label妙用</a></li>
                        
                          <li><a title="Golang 并发问题" href="14727913418128.html">Golang 并发问题</a></li>
                        
                          <li><a title="Golang 反射问题" href="14727911561394.html">Golang 反射问题</a></li>
                        
                          <li><a title="Golang 指针问题" href="14727906220786.html">Golang 指针问题</a></li>
                        
                          <li><a title="Golang 基础类型" href="14726074871676.html">Golang 基础类型</a></li>
                        

                    
                      <li class="side-title"><span>容器相关</span></li>
                        
                          <li><a title="Docker可持续化部署如何做" href="14761747399282.html">Docker可持续化部署如何做</a></li>
                        
                          <li><a title="Kubernetes 监控" href="14750346668025.html">Kubernetes 监控</a></li>
                        
                          <li><a title="容器脚本" href="14726120122280.html">容器脚本</a></li>
                        
                          <li><a title="Kubernetes应用的滚动升级" href="14719470938560.html">Kubernetes应用的滚动升级</a></li>
                        
                          <li><a title="Docker Registry" href="14719166233226.html">Docker Registry</a></li>
                        

                    
                      <li class="side-title"><span>Nginx</span></li>
                        
                          <li><a title="Nginx HTTP2.0" href="14719476150773.html">Nginx HTTP2.0</a></li>
                        
                          <li><a title="Web 基础" href="14719470176268.html">Web 基础</a></li>
                        
                          <li><a title="Let's Encrypt 获取Nginx证书" href="14719253380529.html">Let's Encrypt 获取Nginx证书</a></li>
                        

                    
                      <li class="side-title"><span>数据库</span></li>
                        
                          <li><a title="Golang Postgresql" href="14742795357312.html">Golang Postgresql</a></li>
                        
                          <li><a title="PostgreSql语句集锦" href="14724588246571.html">PostgreSql语句集锦</a></li>
                        
                          <li><a title="Postgresql 备份与恢复" href="14724369503027.html">Postgresql 备份与恢复</a></li>
                        
                          <li><a title="PostgreSql主从配置" href="14719510431478.html">PostgreSql主从配置</a></li>
                        

                    
                      <li class="side-title"><span>股票基础</span></li>
                        
                          <li><a title="个人选股" href="14764202917938.html">个人选股</a></li>
                        
                          <li><a title="选股模型" href="14723863067284.html">选股模型</a></li>
                        
                          <li><a title="股票线图" href="14723721762973.html">股票线图</a></li>
                        
                          <li><a title="股票量价比" href="14723615341044.html">股票量价比</a></li>
                        

                    
                      <li class="side-title"><span>个人收集</span></li>
                        
                          <li><a title="git 常用方法" href="14745419664301.html">git 常用方法</a></li>
                        
                          <li><a title="读书" href="14734878748126.html">读书</a></li>
                        
                          <li><a title="技术类博客收集" href="14727777201831.html">技术类博客收集</a></li>
                        

                    
                      <li class="side-title"><span>算法</span></li>
                        
                          <li><a title="字符串匹配算法" href="14728851727641.html">字符串匹配算法</a></li>
                        

                    
                      <li class="side-title"><span>测试</span></li>
                        
                          <li><a title="Curl Http 测试" href="14742597754498.html">Curl Http 测试</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 <div class="markdown-body">
<h1>Golang Context</h1>

<ol>
<li><p>WithCancel</p>

<pre><code>package main

import (
    &quot;fmt&quot;
    //&quot;context&quot;
    &quot;context&quot;
    &quot;time&quot;
)

type otherContext struct {
    context.Context
    other string
}

func main() {
    // Background 声称一个context的根，是空的，但不是nil，根context是不能够Cancel的
    bkc := context.Background()
    // 生成一个Child Context ，带有Cancel，
    c1, cancel := context.WithCancel(bkc)

    // context 实现了String方法可以被Sprint格式化
    if got, want := fmt.Sprint(c1), &quot;context.Background.WithCancel&quot;; got != want {
        fmt.Errorf(&quot;c1.String() = %q want %q&quot;, got, want)
    }

    // 所有包含Context接口的数据类型都能够当做Context接口类型使用
    o := otherContext{c1, &quot;wonder&quot;}
    //o := otherContext{context.Background(), &quot;wonder&quot;}
    c2, _ := context.WithCancel(o)
    contexts := []context.Context{c1, o, c2}

    /*
            关系图
                bkc
                /
              c1(o)
              /
             c2
    */

    for i, c := range contexts {
        //Done返回值是一个 &lt;-chan struct{}， 返回nil说明这个Context是不能够用关闭的例如：Background生成的Context
        if d := c.Done(); d == nil {
            fmt.Errorf(&quot;c[%d].Done() == %v want non-nil&quot;, i, d)
        }
        // context关闭的原因，如果没有则返回nil， context 关闭之后会返回指定的内容
        if e := c.Err(); e != nil {
            fmt.Errorf(&quot;c[%d].Err() == %v want nil&quot;, i, e)
        }
        // c1和o是同一个context,所以前两个打印出来的内容一样
        tm := c.Done()
        fmt.Println(tm)

        select {
        //此处被block住，执行default，因为context并没有关闭
        case x := &lt;-c.Done():
            fmt.Errorf(&quot;&lt;-c.Done() == %v want nothing (it should block)&quot;, x)
        default:
        }
    }
    // 关闭c1,也就是关闭了o，那么c2也就被关闭了，关闭之后Done所返回的channel 也就关闭了， 关闭之后的channel能够一直取出值
    cancel()
    time.Sleep(100 * time.Millisecond) // let cancelation propagate

    //前面已经Done之后，再次执行Done
    for i, c := range contexts {
        select {
        // 关闭之后c.Done就不再是空
        case &lt;-c.Done():
        default:
            fmt.Errorf(&quot;&lt;-c[%d].Done() blocked, but shouldn&#39;t have&quot;, i)
        }
        if e := c.Err(); e != context.Canceled {
            fmt.Errorf(&quot;c[%d].Err() == %v want %v&quot;, i, e, context.Canceled)
        }
    }

}

</code></pre></li>
<li><p>TimeOut &amp;&amp; DeadLine</p>

<pre><code>    package main

import (
    &quot;fmt&quot;
    //&quot;context&quot;
    &quot;context&quot;
    &quot;strings&quot;
    &quot;time&quot;
)

type otherContext struct {
    context.Context
}

func main() {

    // 50 millisecond 之后自动关闭
    c, _ := context.WithDeadline(context.Background(), time.Now().Add(50*time.Millisecond))
    if got, prefix := fmt.Sprint(c), &quot;context.Background.WithDeadline(&quot;; !strings.HasPrefix(got, prefix) {
        fmt.Errorf(&quot;c.String() = %q want prefix %q&quot;, got, prefix)
    }
    testDeadline(c, &quot;WithDeadline&quot;, time.Second)

    // 继承context的类型使用WithDeadline
    c, _ = context.WithDeadline(context.Background(), time.Now().Add(50*time.Millisecond))
    o := otherContext{c}
    testDeadline(o, &quot;WithDeadline+otherContext&quot;, time.Second)

    // Parent Context 超时时间比 Child Context 超时时间短
    c, _ = context.WithDeadline(context.Background(), time.Now().Add(50*time.Millisecond))
    o = otherContext{c}
    c, _ = context.WithDeadline(o, time.Now().Add(4*time.Second))
    // 结果为：Parent Context 超时
    testDeadline(c, &quot;WithDeadline+otherContext+WithDeadline&quot;, 2*time.Second)

    // 超时时间是负数，直接超时
    c, _ = context.WithDeadline(context.Background(), time.Now().Add(-time.Millisecond))
    testDeadline(c, &quot;WithDeadline+inthepast&quot;, time.Second)

    // 超时时间是现在时间，直接超时
    c, _ = context.WithDeadline(context.Background(), time.Now())
    testDeadline(c, &quot;WithDeadline+now&quot;, time.Second)

    // WithTimeout

    c, _ = context.WithTimeout(context.Background(), 50*time.Millisecond)
    if got, prefix := fmt.Sprint(c), &quot;context.Background.WithDeadline(&quot;; !strings.HasPrefix(got, prefix) {
        fmt.Errorf(&quot;c.String() = %q want prefix %q&quot;, got, prefix)
    }
    testDeadline(c, &quot;WithTimeout&quot;, time.Second)

    c, _ = context.WithTimeout(context.Background(), 50*time.Millisecond)
    o = otherContext{c}
    testDeadline(o, &quot;WithTimeout+otherContext&quot;, time.Second)

    c, _ = context.WithTimeout(context.Background(), 50*time.Millisecond)
    o = otherContext{c}
    c, _ = context.WithTimeout(o, 3*time.Second)
    testDeadline(c, &quot;WithTimeout+otherContext+WithTimeout&quot;, 2*time.Second)

    // Cancel TimeOut
    // Cancel 能够立马生效
    c, _ = context.WithTimeout(context.Background(), time.Second)
    o = otherContext{c}
    c, cancel := context.WithTimeout(o, 2*time.Second)
    cancel()
    time.Sleep(100 * time.Millisecond) // let cancelation propagate
    select {
    case &lt;-c.Done():
    default:
        fmt.Errorf(&quot;&lt;-c.Done() blocked, but shouldn&#39;t have&quot;)
    }
    if e := c.Err(); e != context.Canceled {
        fmt.Errorf(&quot;c.Err() == %v want %v&quot;, e, context.Canceled)
    }

}

func testDeadline(c context.Context, name string, failAfter time.Duration) {
    select {
    case &lt;-time.After(failAfter):
        fmt.Errorf(&quot;%s: context should have timed out&quot;, name)
    case &lt;-c.Done():
        // context closed
    }
    if e := c.Err(); e != context.DeadlineExceeded {
        fmt.Errorf(&quot;%s: c.Err() == %v; want %v&quot;, name, e, context.DeadlineExceeded)
    }
}

</code></pre></li>
<li><p>WithValue</p>

<pre><code>package main

import (
    &quot;fmt&quot;
    &quot;context&quot;
)

type otherContext struct {
    context.Context
}

type Key struct {
    name string
    age  int
}

func main() {

    sKey := Key{&quot;izgnod&quot;, 18}
    c0 := context.Background()
    fmt.Println(c0)

    c1 := context.WithValue(c0, &quot;k1&quot;, &quot;value1&quot;)
    fmt.Printf(&quot;key: k1 value:%s\n&quot;, c1.Value(&quot;k1&quot;))

    c2 := context.WithValue(c1, &quot;k2&quot;, sKey)
    switch t := c2.Value(&quot;k2&quot;).(type) {
    case Key:
        fmt.Printf(&quot;key: k2 value:Key{name:%s,age:%d}\n&quot;, t.name, t.age)
    default:
        fmt.Println(&quot;unknow&quot;)

    }
    fmt.Println(c2.Value(&quot;k1&quot;))

}
</code></pre></li>
</ol>


</div>

<br /><br />
<hr />

<div class="row clearfix">
  <div class="large-6 columns">
	<div class="text-left" style="padding:15px 0px;">
		
	        <a href="14750346668025.html"  title="Previous Post: Kubernetes 监控">&laquo; Kubernetes 监控</a>
	    
	</div>
  </div>
  <div class="large-6 columns">
	<div class="text-right" style="padding:15px 0px;">
		
	        <a href="14745419664301.html" 
	        title="Next Post: git 常用方法">git 常用方法 &raquo;</a>
	    
	</div>
  </div>
</div>

<div class="row">
<div style="padding:0px 0.93em;" class="share-comments">
<!-- 多说评论框 start -->
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"fuckall"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
</div>
</div>
<script type="text/javascript">
	$(function(){
		var currentURL = '14746196382822.html';
		$('#side-nav a').each(function(){
			if($(this).attr('href') == currentURL){
				$(this).parent().addClass('active');
			}
		});
	});
</script>  
</div></div>


<div class="page-bottom">
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    <script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  </body>
</html>
